<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIPAS 智庫 3.0 - 決策審計與人名關聯系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { --sidebar-width: 260px; --primary: #0f172a; --accent: #2563eb; --success: #059669; --warning: #d97706; --danger: #dc2626; }
        body { background: #f8fafc; font-family: "Inter", "Microsoft JhengHei", sans-serif; color: #334155; }
        
        #sidebar { width: var(--sidebar-width); position: fixed; height: 100vh; background: var(--primary); color: white; padding: 1.5rem; z-index: 1000; }
        #main-content { margin-left: var(--sidebar-width); padding: 2rem; min-height: 100vh; }
        
        .nav-link { color: #94a3b8; border-radius: 8px; padding: 0.7rem 1rem; margin-bottom: 0.4rem; transition: all 0.2s; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-link.active { background: var(--accent); }

        /* Issue Tags */
        .status-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 6px; font-weight: 800; display: inline-flex; align-items: center; gap: 4px; }
        .status-agreed { background: #dcfce7; color: #166534; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-noted { background: #f1f5f9; color: #475569; }
        .status-partial { background: #fff7ed; color: #c2410c; border: 1px solid #fdba74; }
        
        .money-tag { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-family: monospace; }

        /* Member Profile */
        .member-card { cursor: pointer; transition: transform 0.2s; border-left: 4px solid #cbd5e1; }
        .member-card:hover { transform: scale(1.02); border-left-color: var(--accent); }
        
        /* Issue Lifecycle */
        .lifecycle-indicator { font-size: 0.75rem; color: #64748b; margin-top: 1.5rem; border-top: 1px dashed #e2e8f0; padding-top: 1rem; }
        
        .modal-xl { max-width: 1140px; }
        .timeline-mini { border-left: 2px solid #e2e8f0; padding-left: 1rem; margin-left: 0.5rem; }
        .related-item { font-size: 0.85rem; display: block; text-decoration: none; color: #1e40af; padding: 4px 0; }
        .related-item:hover { text-decoration: underline; }
    </style>
</head>
<body>

<nav id="sidebar">
    <div class="mb-5 px-2">
        <h4 class="fw-bold"><i class="bi bi-cpu-fill me-2"></i>CIPAS Intelligence</h4>
        <small class="text-slate-400">決策審計與人名關聯系統</small>
    </div>
    <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="bi bi-arrow-left-circle me-2"></i> 案件儀表板</a></li>
        <li class="nav-item"><a class="nav-link" id="nav-list" href="#/list"><i class="bi bi-table me-2"></i> 會議清單</a></li>
        <li class="nav-item"><a class="nav-link" id="nav-members" href="#/members"><i class="bi bi-people me-2"></i> 委員出席庫</a></li>
        <li class="nav-item"><a class="nav-link" id="nav-audit" href="#/audit"><i class="bi bi-bank me-2"></i> 財政動支審計</a></li>
        <li class="nav-item"><a class="nav-link" id="nav-org-budget" href="#/org-budget"><i class="bi bi-calendar-range me-2"></i> 組織預算追蹤</a></li>
    </ul>
</nav>

<main id="main-content">
    <div id="view-container"></div>
</main>

<!-- Member Detail Modal -->
<div class="modal fade" id="memberModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="member-modal-content"></div>
    </div>
</div>

<script src="meetings_data.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const allData = typeof meetingsData !== 'undefined' ? meetingsData : [];
    const memberStats = {};
    const parsedCache = new Map();
    const KEY_ORGS = [
        { name: '中國廣播', keywords: ['中廣', '中國廣播'] },
        { name: '中國青年救國團', keywords: ['救國團', '青年救國團'] },
        { name: '中央投資', keywords: ['中投', '中央投資'] },
        { name: '欣裕台', keywords: ['欣裕台'] },
        { name: '中華救助總會', keywords: ['救助總會', '救總', '中華救助'] },
        { name: '婦聯會', keywords: ['婦聯會', '婦女聯合會'] }
    ];

    // --- 強化解析引擎 ---
    function deepParseMeeting(item) {
        if (parsedCache.has(item.id)) return parsedCache.get(item.id);

        let text = (item.content_text || "").replace(/\\n/g, '\n');
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        
        const res = {
            id: item.id, title: item.title, date: item.date,
            time: "", location: "", chairman: {}, members: [], staff: [],
            issues: []
        };

        let currentSection = "";
        let currentItem = null;
        let isCapturingDecision = false;

        lines.forEach(line => {
            if (line.includes('壹、時間：')) res.time = line.split('：')[1];
            if (line.includes('貳、地點：')) res.location = line.split('：')[1];
            if (line.includes('參、主席：')) {
                const chairRaw = line.split('：')[1];
                res.chairman = parsePeople(chairRaw)[0] || { name: chairRaw, title: "主席" };
            }
            if (line.match(/^肆、出席(?:人員|委員)：/)) {
                res.members = parsePeople(line.replace(/^肆、出席(?:人員|委員)：/, ''));
                res.members.forEach(m => {
                    if (!memberStats[m.name]) memberStats[m.name] = { name: m.name, title: m.title, meetings: [] };
                    if (!memberStats[m.name].meetings.find(mt => mt.id === res.id)) {
                        memberStats[m.name].meetings.push({ id: res.id, title: res.title, date: res.date });
                    }
                });
            }
            if (line.match(/^列席(?:單位|人員)：/)) {
                res.staff = line.replace(/^列席(?:單位|人員)：/, '').split(/[、，；]+/).map(s => s.trim());
            }

            if (line.match(/^[柒柒]、報告事項/)) { currentSection = "報告"; return; }
            if (line.match(/^[捌捌]、討論事項/)) { currentSection = "討論"; return; }

            const itemMatch = line.match(/^([一二三四五六七八九十]+)、(.+)/);
            if (itemMatch && currentSection) {
                if (currentItem) res.issues.push(currentItem);
                currentItem = { 
                    section: currentSection, no: itemMatch[1], title: itemMatch[2], 
                    decision: "", desc: [], status: "pending", money: extractMoney(itemMatch[2]) || []
                };
                isCapturingDecision = false;
            } else if (currentItem) {
                if (line.match(/^(決定|決議)[:：]/)) {
                    currentItem.decision = line;
                    isCapturingDecision = true;
                } else if (isCapturingDecision) {
                    currentItem.decision += " " + line;
                    currentItem.status = analyzeStatus(currentItem.decision);
                    const decMoney = extractMoney(line);
                    if (decMoney) currentItem.money = [...new Set([...currentItem.money, ...decMoney])];
                } else if (!line.match(/^[壹貳參肆伍陸柒捌玖拾]、/)) {
                    currentItem.desc.push(line);
                    const lineMoney = extractMoney(line);
                    if (lineMoney) currentItem.money = [...new Set([...currentItem.money, ...lineMoney])];
                }
            }
        });
        if (currentItem) res.issues.push(currentItem);
        parsedCache.set(item.id, res);
        return res;
    }

    function parsePeople(raw) {
        if (!raw) return [];
        return raw.replace(/等$/, '').split(/[、，；\s]+/).filter(s => s.length > 1).map(part => {
            const cleanName = part.replace(/[（\(]請假[）\)]/g, '').trim();
            const m = cleanName.match(/^(.+?委員|主任委員|副主任委員|主任秘書|組長|調查員)(.+)$/);
            if (m) return { title: m[1], name: m[2] };
            if (cleanName.length > 3 && (cleanName.includes('委員') || cleanName.includes('主任'))) {
                 const idx = cleanName.indexOf('委員') > -1 ? cleanName.indexOf('委員') + 2 : (cleanName.indexOf('主任') > -1 ? cleanName.indexOf('主任') + 2 : 2);
                 return { title: cleanName.substring(0, idx), name: cleanName.substring(idx) };
            }
            return { title: "委員", name: cleanName };
        }).filter(m => m.name);
    }

    function extractMoney(text) {
        const regex = /([0-9,]+[億萬]?[0-9,]*[億萬]?[0-9,]*|[0-9,]+)元/g;
        const matches = [];
        let m;
        while ((m = regex.exec(text)) !== null) {
            matches.push(m[1]);
        }
        return matches.length > 0 ? matches : null;
    }

    function analyzeStatus(text) {
        const hasAgree = text.includes('同意') || text.includes('許可');
        const hasDeny = text.includes('否准') || text.includes('不同意') || text.includes('不予') || text.includes('駁回');
        const hasPending = text.includes('保留') || text.includes('一次') || text.includes('暫予');
        const hasNoted = text.includes('洽悉');

        if (hasAgree && hasDeny) return 'partial';
        if (hasDeny) return 'rejected';
        if (hasAgree) return 'agreed';
        if (hasNoted) return 'noted';
        return 'pending';
    }

    function router() {
        const hash = window.location.hash || '#/list';
        const container = document.getElementById('view-container');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

        if (hash.startsWith('#/list')) {
            document.getElementById('nav-list').classList.add('active');
            renderList(container, hash);
        } else if (hash.startsWith('#/meeting/')) {
            renderMeetingDetail(container, hash.split('/').pop().split('?')[0]);
        } else if (hash === '#/members') {
            document.getElementById('nav-members').classList.add('active');
            renderMembers(container);
        } else if (hash === '#/audit') {
            document.getElementById('nav-audit').classList.add('active');
            renderAudit(container);
        } else if (hash.startsWith('#/org-budget')) {
            document.getElementById('nav-org-budget').classList.add('active');
            renderOrgBudget(container, hash);
        }
    }

    function renderList(container, hash) {
        const query = new URLSearchParams(hash.split('?')[1]).get('q') || '';
        const items = allData.filter(d => d.title.includes(query)).sort((a,b) => b.id - a.id);
        
        container.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">會議深度紀錄列表</h2>
                <span class="badge bg-primary rounded-pill">共 ${items.length} 筆資料</span>
            </div>
            <div class="row g-3">
                ${items.map(d => `
                    <div class="col-12">
                        <div class="card border-0 shadow-sm p-3 member-card" onclick="location.hash='#/meeting/${d.id}'">
                            <div class="d-flex justify-content-between">
                                <h6 class="fw-bold mb-0">${d.title}</h6>
                                <span class="text-muted small">${d.date}</span>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>`;
    }

    function renderMeetingDetail(container, id) {
        const raw = allData.find(d => d.id.toString() === id.toString());
        if (!raw) return;
        const m = deepParseMeeting(raw);

        container.innerHTML = `
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm p-4 mb-4">
                        <h2 class="fw-bold mb-3">${m.title}</h2>
                        <div class="d-flex gap-4 text-muted small">
                            <span><i class="bi bi-calendar-event me-2"></i>${m.date}</span>
                            <span><i class="bi bi-geo-alt me-2"></i>${m.location}</span>
                        </div>
                    </div>

                    ${m.issues.map(issue => {
                        const statusMap = {
                            agreed: { label: '同意', class: 'status-agreed', icon: 'bi-check-circle-fill' },
                            partial: { label: '部分核定', class: 'status-partial', icon: 'bi-exclamation-triangle-fill' },
                            rejected: { label: '否准/駁回', class: 'status-rejected', icon: 'bi-x-circle-fill' },
                            noted: { label: '洽悉', class: 'status-noted', icon: 'bi-info-circle' },
                            pending: { label: '處理中/保留', class: 'status-pending', icon: 'bi-hourglass-split' }
                        };
                        const st = statusMap[issue.status] || statusMap.pending;

                        return `
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white border-bottom-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                                <span class="badge ${issue.section==='討論'?'bg-primary':'bg-info'}">${issue.section}案號：${issue.no}</span>
                                <div class="d-flex gap-2">
                                    ${issue.money.map(mon => `<span class="money-tag">NT$ ${mon}</span>`).join('')}
                                    <span class="status-badge ${st.class}">
                                        <i class="bi ${st.icon} me-1"></i> ${st.label}
                                    </span>
                                </div>
                            </div>
                            <div class="card-body px-4 pb-4">
                                <h5 class="fw-bold mb-3 text-dark">${issue.title}</h5>
                                <p class="text-secondary small mb-3" style="line-height:1.7;">${issue.desc.join('<br>')}</p>
                                <div class="p-3 bg-light rounded border-start border-4 ${issue.status==='partial'?'border-warning':(issue.status==='agreed'?'border-success':'border-primary')}">
                                    <strong class="d-block mb-1">${issue.decision.split('：')[0]}</strong>
                                    <div class="small text-dark">${issue.decision.split('：')[1] || '內容參閱內文'}</div>
                                </div>
                                ${renderLifecycle(issue, m.id)}
                            </div>
                        </div>`}).join('')}
                </div>
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm p-4 sticky-top" style="top:2rem;">
                        <h6 class="fw-bold mb-3">出席委員會員</h6>
                        <div class="d-flex flex-wrap gap-2">
                            ${m.members.map(mem => `<span class="badge bg-light text-dark border p-2 cursor-pointer" onclick="showMember('${mem.name}')">${mem.name} <small class="text-muted">${mem.title}</small></span>`).join('')}
                        </div>
                        <hr>
                        <h6 class="fw-bold mb-3">列席單位</h6>
                        <div class="small text-muted">${m.staff.join('、')}</div>
                    </div>
                </div>
            </div>`;
    }

    function renderLifecycle(issue, currentId) {
        const cleanTitle = issue.title.replace(/[0-9]{2,3}年[0-9]{1,2}月[份]?/g, '').substring(0, 10);
        const history = allData.filter(d => d.id.toString() !== currentId.toString() && d.title.includes(cleanTitle)).slice(0, 5);
        if (history.length === 0) return '';

        return `
            <div class="lifecycle-indicator">
                <div class="fw-bold text-primary mb-2 small"><i class="bi bi-diagram-3"></i> 跨會議議題鏈結：${cleanTitle}</div>
                <div class="timeline-mini">
                    ${history.map(h => `<a href="#/meeting/${h.id}" class="related-item"><i class="bi bi-clock-history me-2"></i> ${h.date} ${h.title.substring(0,30)}...</a>`).join('')}
                </div>
                ${issue.status === 'noted' ? '<div class="mt-2 text-warning x-small"><i class="bi bi-exclamation-triangle"></i> 注意：此議題目前僅為「洽悉」，需追蹤後續是否有實質討論。</div>' : ''}
            </div>`;
    }

    function renderMembers(container) {
        allData.forEach(deepParseMeeting);
        const sortedMembers = Object.values(memberStats).sort((a,b) => b.meetings.length - a.meetings.length);
        
        container.innerHTML = `
            <h2 class="fw-bold mb-4">委員出席率與活躍度分析</h2>
            <div class="row g-4">
                ${sortedMembers.map(m => `
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm p-4 member-card" onclick="showMember('${m.name}')">
                            <h5 class="fw-bold mb-1">${m.name}</h5>
                            <div class="text-primary small mb-3">${m.title}</div>
                            <div class="d-flex justify-content-between align-items-end">
                                <div><span class="display-6 fw-bold">${m.meetings.length}</span><span class="text-muted"> 場會議</span></div>
                                <div class="text-success small">出席率: ${Math.round(m.meetings.length / allData.length * 100)}%</div>
                            </div>
                        </div>
                    </div>`).join('')}
            </div>`;
    }

    window.showMember = function(name) {
        const m = memberStats[name];
        if (!m) return;
        const content = document.getElementById('member-modal-content');
        content.innerHTML = `
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">${name} 委員參與歷程</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <span class="badge bg-primary px-3 py-2">${m.title}</span>
                    <span class="ms-3 text-muted">總共出席 ${m.meetings.length} 場會議</span>
                </div>
                <h6 class="fw-bold mb-3">出席明細 (依時間排序)</h6>
                <div class="list-group list-group-flush">
                    ${m.meetings.sort((a,b) => b.id - a.id).map(mt => `
                        <a href="#/meeting/${mt.id}" data-bs-dismiss="modal" class="list-group-item list-group-item-action d-flex justify-content-between">
                            <span>${mt.title}</span><span class="text-muted small">${mt.date}</span>
                        </a>`).join('')}
                </div>
            </div>`;
        new bootstrap.Modal(document.getElementById('memberModal')).show();
    };

    function renderAudit(container) {
        allData.forEach(deepParseMeeting);
        const moneyIssues = [];
        allData.forEach(d => {
            const m = deepParseMeeting(d);
            m.issues.forEach(i => { if (i.money.length > 0) moneyIssues.push({...i, meeting: m.title, id: m.id}); });
        });

        container.innerHTML = `
            <h2 class="fw-bold mb-4">財政動支審計 (金額追蹤)</h2>
            <div class="table-responsive bg-white rounded shadow-sm">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr><th>日期/會議</th><th>議題</th><th>金額 (NT$)</th><th>決策狀態</th></tr>
                    </thead>
                    <tbody>
                        ${moneyIssues.map(i => `
                            <tr>
                                <td class="small"><a href="#/meeting/${i.id}">${i.meeting}</a></td>
                                <td class="fw-bold">${i.title}</td>
                                <td>${i.money.map(m => `<span class="money-tag d-block mb-1">NT$ ${m}</span>`).join('')}</td>
                                <td><span class="status-badge status-${i.status}">${i.status}</span></td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    function renderOrgBudget(container, hash) {
        const params = new URLSearchParams(hash.includes('?') ? hash.split('?')[1] : '');
        const orgName = params.get('org');

        if (!orgName) {
            container.innerHTML = `
                <h2 class="fw-bold mb-4">組織預算追蹤中心</h2>
                <div class="row g-4">
                    ${KEY_ORGS.map(org => `
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm p-4 member-card" onclick="location.hash='#/org-budget?org=${encodeURIComponent(org.name)}'">
                                <h5 class="fw-bold mb-2">${org.name}</h5>
                                <div class="text-muted small">追蹤歷月營運支出與現金動支案</div>
                                <div class="mt-3 text-primary fw-bold">進入專用閱讀視角 →</div>
                            </div>
                        </div>`).join('')}
                </div>`;
            return;
        }

        const org = KEY_ORGS.find(o => o.name === orgName);
        const relatedIssues = [];
        allData.forEach(d => {
            const m = deepParseMeeting(d);
            m.issues.forEach(i => {
                if (org.keywords.some(k => i.title.includes(k)) && (i.title.includes('支出') || i.title.includes('預算'))) {
                    relatedIssues.push({ ...i, meetingDate: m.date, meetingId: m.id, meetingTitle: m.title });
                }
            });
        });

        relatedIssues.sort((a,b) => new Date(b.meetingDate) - new Date(a.meetingDate));

        container.innerHTML = `
            <div class="mb-4"><a href="#/org-budget" class="btn btn-sm btn-light border"><i class="bi bi-chevron-left"></i> 返回選擇</a></div>
            <h2 class="fw-bold mb-4">${orgName} 預算動支追蹤矩陣</h2>
            <div class="timeline-mini">
                ${relatedIssues.map(i => `
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge bg-light text-dark border">${i.meetingDate}</span>
                                <div class="d-flex gap-2">
                                    ${i.money.map(m => `<span class="money-tag">NT$ ${m}</span>`).join('')}
                                    <span class="status-badge status-${i.status}">${i.status}</span>
                                </div>
                            </div>
                            <h6 class="fw-bold"><a href="#/meeting/${i.meetingId}" class="text-dark text-decoration-none">${i.title}</a></h6>
                            <div class="bg-light p-2 rounded mt-2 small border-start border-3 ${i.status==='agreed'?'border-success':(i.status==='partial'?'border-warning':'border-primary')}">
                                <strong>決策內容：</strong>${i.decision.split('：')[1] || '內容參閱內文'}
                            </div>
                        </div>
                    </div>`).join('')}
            </div>`;
    }

    window.addEventListener('hashchange', router);
    window.addEventListener('load', router);
</script>
</body>
</html>