<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIPAS 程序阻塞與司法統計</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f7f6; font-family: "Inter", "Microsoft JhengHei", sans-serif; }
        .stats-card { background: white; border-radius: 15px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 1.5rem; margin-bottom: 2rem; }
        .nav-year { position: fixed; right: 30px; top: 100px; }
        .timeline-item { border-left: 3px solid #dee2e6; padding-left: 20px; position: relative; margin-bottom: 2rem; }
        .timeline-item::before { content: ""; position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: #0d6efd; border: 3px solid white; }
        .court-win { border-left-color: #198754; }
        .court-lose { border-left-color: #dc3545; }
        .blocking-list { max-height: 400px; overflow-y: auto; }
        .blocking-item { padding: 10px; border-bottom: 1px solid #eee; transition: background 0.2s; cursor: pointer; }
        .blocking-item:hover { background: #f8f9fa; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <h1 class="fw-bold"><i class="bi bi-bar-chart-line me-2"></i>程序阻塞與司法統計</h1>
        <a href="dashboard.html" class="btn btn-outline-dark">返回組織流水線</a>
    </div>

    <!-- 頂部統計 KPI -->
    <div class="row g-4 mb-5" id="kpi-row"></div>

    <div class="row">
        <!-- 左側：程序阻塞分析 -->
        <div class="col-lg-5">
            <div class="stats-card">
                <h5 class="fw-bold mb-3"><i class="bi bi-hourglass-split me-2 text-warning"></i>程序阻塞分析</h5>
                <p class="text-muted small">識別哪些組織目前「僅有前期程序」而無行政處分</p>
                
                <ul class="nav nav-tabs mb-3" id="blockTab" role="tablist">
                    <li class="nav-item"><button class="nav-link active small" data-bs-toggle="tab" data-bs-target="#only-invest">僅調查案</button></li>
                    <li class="nav-item"><button class="nav-link small" data-bs-toggle="tab" data-bs-target="#only-hearing">僅聽證案</button></li>
                </ul>
                <div class="tab-content blocking-list" id="blockTabContent">
                    <div class="tab-pane fade show active" id="only-invest"></div>
                    <div class="tab-pane fade" id="only-hearing"></div>
                </div>
            </div>
        </div>

        <!-- 右側：深度時間軸 -->
        <div class="col-lg-7">
            <div class="stats-card">
                <h5 class="fw-bold mb-4"><i class="bi bi-calendar3 me-2 text-primary"></i>全程序詳細時間日誌</h5>
                <div id="full-timeline"></div>
            </div>
        </div>
    </div>
</div>

<script src="cipas_full_data.js"></script>
<script>
    const allData = typeof cipasFullData !== 'undefined' ? cipasFullData : [];
    
    // 1. 程序阻塞分析
    function analyzeBlocking() {
        const orgs = {};
        allData.forEach(item => {
            item.analysis.forEach(org => {
                const name = org.org_full;
                if (!orgs[name]) orgs[name] = { invest: 0, hearing: 0, action: 0 };
                if (item.category_key === 'investigations') orgs[name].invest++;
                if (item.category_key === 'hearings') orgs[name].hearing++;
                if (item.category_key === 'administrative_actions') orgs[name].action++;
            });
        });

        const onlyInvest = Object.values(orgs).filter(o => o.invest > 0 && o.action === 0);
        const onlyHearing = Object.values(orgs).filter(o => o.hearing > 0 && o.action === 0);

        document.getElementById('only-invest').innerHTML = onlyInvest.map(o => `
            <div class="blocking-item" onclick="location.href='dashboard.html#/org/${encodeURIComponent(o.name)}'">
                <div class="fw-bold small">${o.name}</div>
                <div class="text-muted" style="font-size: 0.7rem;">累積調查件數：${o.invest}</div>
            </div>`).join('') || '<p class="text-muted p-3">無阻塞案件</p>';

        document.getElementById('only-hearing').innerHTML = onlyHearing.map(o => `
            <div class="blocking-item" onclick="location.href='dashboard.html#/org/${encodeURIComponent(o.name)}'">
                <div class="fw-bold small">${o.name}</div>
                <div class="text-muted" style="font-size: 0.7rem;">累積聽證件數：${o.hearing}</div>
            </div>`).join('') || '<p class="text-muted p-3">無阻塞案件</p>';
    }

    // 2. 深度時間軸渲染
    function renderTimeline() {
        const events = [];
        allData.forEach(item => {
            item.events.forEach(e => {
                const date = new Date(e.date);
                if (isNaN(date.getTime())) return;
                
                let type = 'normal';
                if (e.caption.includes('駁回') || e.caption.includes('不停止執行')) type = 'win';
                if (e.caption.includes('撤銷') || e.caption.includes('停止執行')) type = 'lose';

                events.push({
                    date: date,
                    dateStr: e.date,
                    org: item.analysis[0]?.org_full || '未知組織',
                    caption: e.caption,
                    desc: e.description,
                    type: type,
                    caseId: item.id
                });
            });
        });

        events.sort((a,b) => b.date - a.date);

        document.getElementById('full-timeline').innerHTML = events.map(e => `
            <div class="timeline-item ${e.type === 'win' ? 'court-win' : (e.type === 'lose' ? 'court-lose' : '')}">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold small text-primary">${e.org}</span>
                    <small class="text-muted">${e.dateStr}</small>
                </div>
                <div class="fw-bold mb-1" style="font-size: 0.85rem;">${e.caption}</div>
                ${e.desc ? `<div class="text-muted x-small p-2 bg-light rounded mt-1" style="font-size: 0.75rem;">${e.desc}</div>` : ''}
                <a href="dashboard.html#/case/${e.caseId}" class="btn btn-sm btn-link p-0 x-small mt-1 text-decoration-none" style="font-size: 0.7rem;">查看案件詳情 →</a>
            </div>`).join('');
    }

    // 3. 頂部 KPI
    function renderKPI() {
        const stats = {
            total: allData.length,
            wins: 0,
            actions: allData.filter(i => i.category_key === 'administrative_actions').length
        };
        allData.forEach(i => {
            if (i.events.some(e => e.caption.includes('駁回') || e.caption.includes('不停止執行'))) stats.wins++;
        });

        document.getElementById('kpi-row').innerHTML = `
            <div class="col-md-4"><div class="stats-card text-center border-top border-primary border-4"><h3>${stats.total}</h3><small class="text-muted">總程序發動</small></div></div>
            <div class="col-md-4"><div class="stats-card text-center border-top border-danger border-4"><h3>${stats.actions}</h3><small class="text-muted">成功產出處分</small></div></div>
            <div class="col-md-4"><div class="stats-card text-center border-top border-success border-4"><h3>${stats.wins}</h3><small class="text-muted">法院判決勝訴</small></div></div>
        `;
    }

    window.onload = () => {
        analyzeBlocking();
        renderTimeline();
        renderKPI();
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
