<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIPAS 全生命週期監控系統 (深度績效版)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { --sidebar-width: 280px; }
        body { background-color: #f8f9fa; font-family: "Inter", "Microsoft JhengHei", sans-serif; }
        #sidebar { width: var(--sidebar-width); position: fixed; height: 100vh; background: #1a1d20; color: white; padding: 1.5rem; overflow-y: auto; z-index: 1000; }
        #main-content { margin-left: var(--sidebar-width); padding: 2rem; min-height: 100vh; }
        .glass-card { background: white; border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .kpi-card { border-left: 5px solid #0d6efd; transition: transform 0.2s; }
        .phase-column { background: #f1f3f5; border-radius: 12px; padding: 1.25rem; height: 100%; border: 1px solid #e9ecef; }
        .phase-title { font-weight: 800; color: #495057; margin-bottom: 1rem; font-size: 0.9rem; text-transform: uppercase; border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem; }
        .group-header { font-size: 0.75rem; font-weight: bold; color: #0d6efd; margin: 1.2rem 0 0.4rem 0; padding-left: 5px; border-left: 3px solid #0d6efd; }
        .case-card { background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.8rem; border: 1px solid #dee2e6; cursor: pointer; transition: all 0.2s; }
        .case-card:hover { border-color: #0d6efd; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .status-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .nav-link { color: #adb5bd; border-radius: 8px; margin-bottom: 0.4rem; }
        .nav-link:hover, .nav-link.active { background: #343a40; color: white; }
        .event-desc { font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem; background: #f8f9fa; padding: 8px; border-radius: 4px; border-left: 3px solid #dee2e6; white-space: pre-wrap; }
    </style>
</head>
<body>

<nav id="sidebar">
    <div class="mb-4 d-flex align-items-center"><i class="bi bi-shield-shaded fs-3 me-2 text-primary"></i><h4 class="fw-bold mb-0">CIPAS</h4></div>
    <ul class="nav flex-column" id="org-nav"></ul>
</nav>

<main id="main-content">
    <div id="view-container"></div>
</main>

<script src="cipas_full_data.js"></script>
<script>
    const allData = typeof cipasFullData !== 'undefined' ? cipasFullData : [];
    
    function getSubGroup(title) {
        if (title.includes('中廣') || title.includes('中影') || title.includes('中投') || title.includes('欣裕台')) return '附隨組織與事業';
        if (title.includes('黨部') || title.includes('辦公廳舍') || title.includes('大孝大樓') || title.includes('舊中央黨部')) return '黨部與地方不動產';
        if (title.includes('土地') || title.includes('價額') || title.includes('追徵')) return '土地與價額追徵';
        return '其他綜合類';
    }

    function analyzeItem(item) {
        let status = { label: '處理中', class: 'bg-secondary text-white', score: 0 };
        const latest = [...item.events].sort((a,b) => new Date(b.date) - new Date(a.date))[0]?.caption || "";
        
        if (item.category_key === 'litigations') {
            if (latest.includes('駁回') || latest.includes('不停止執行')) status = { label: '勝訴/維持', class: 'bg-success text-white', score: 1 };
            else if (latest.includes('撤銷') || latest.includes('停止執行')) status = { label: '遭挑戰', class: 'bg-danger text-white', score: -1 };
            else status = { label: '法院審理', class: 'bg-primary text-white', score: 0 };
        } else if (item.category_key === 'administrative_actions') {
            status = { label: '已作成處分', class: 'bg-danger text-white', score: 1 };
        }
        
        const hasOrder = item.events.some(e => e.caption.includes('作成') && e.caption.includes('處分'));
        const isRecognition = item.title.includes('認定') && (item.title.includes('附隨組織') || item.title.includes('為'));
        
        return { ...item, displayStatus: status, hasOrder, isRecognition, subGroup: getSubGroup(item.title) };
    }

    const processedData = allData.map(analyzeItem);
    const orgMap = {};
    processedData.forEach(item => {
        item.analysis.forEach(org => {
            if (!orgMap[org.org_full]) orgMap[org.org_full] = { name: org.org_full, cases: [] };
            orgMap[org.org_full].cases.push(item);
        });
    });

    const router = () => {
        const hash = window.location.hash || '#/';
        const container = document.getElementById('view-container');
        if (hash === '#/') renderKPI(container);
        else if (hash.startsWith('#/org/')) renderOrgFlow(container, decodeURIComponent(hash.split('/').pop()));
        else if (hash.startsWith('#/case/')) renderDetail(container, hash.split('/').pop());
        updateSidebar();
    };

    function renderKPI(container) {
        const totalLit = processedData.filter(i => i.category_key === 'litigations').length;
        const wins = processedData.filter(i => i.displayStatus.score === 1 && i.category_key === 'litigations').length;
        const orders = processedData.filter(i => i.hasOrder || i.category_key === 'administrative_actions').length;

        container.innerHTML = `
            <h1 class="fw-bold mb-4">系統績效監控儀錶板</h1>
            <div class="row g-4 mb-5">
                <div class="col-md-4"><div class="card glass-card kpi-card p-4">
                    <small class="text-muted text-uppercase fw-bold">核心績效 (第 6 條處分)</small>
                    <h2 class="display-5 fw-bold mb-0">${orders} <span class="fs-6 text-primary">件已處分</span></h2>
                </div></div>
                <div class="col-md-4"><div class="card glass-card kpi-card p-4" style="border-left-color: #198754;">
                    <small class="text-muted text-uppercase fw-bold">法院攻防勝場</small>
                    <h2 class="display-5 fw-bold mb-0">${wins} <span class="fs-6 text-success">處分獲維持</span></h2>
                </div></div>
                <div class="col-md-4"><div class="card glass-card kpi-card p-4" style="border-left-color: #0dcaf0;">
                    <small class="text-muted text-uppercase fw-bold">處分勝率</small>
                    <h2 class="display-5 fw-bold mb-0">${totalLit > 0 ? Math.round(wins/totalLit*100) : 0}% <span class="fs-6 text-info">法理穩定度</span></h2>
                </div></div>
            </div>
            <div class="row g-4">
                ${Object.keys(orgMap).sort().map(name => `
                    <div class="col-md-4">
                        <div class="card glass-card p-3 h-100">
                            <h5 class="fw-bold">${name}</h5><p class="text-muted small">關聯程序：${orgMap[name].cases.length} 筆</p>
                            <a href="#/org/${encodeURIComponent(name)}" class="btn btn-sm btn-outline-primary mt-auto">查看流水線</a>
                        </div>
                    </div>`).join('')}
            </div>`;
    }

    function renderOrgFlow(container, name) {
        const org = orgMap[name];
        const cases = org.cases;
        const init = cases.filter(c => c.category_key === 'investigations' || c.category_key === 'hearings');
        const recognition = cases.filter(c => c.isRecognition && (c.category_key === 'administrative_actions' || c.category_key === 'litigations'));
        const execution = cases.filter(c => !c.isRecognition && (c.category_key === 'administrative_actions' || c.category_key === 'litigations'));

        container.innerHTML = `
            <div class="mb-3"><a href="#/" class="text-decoration-none text-muted"><i class="bi bi-arrow-left"></i> 返回概覽</a></div>
            <h1 class="fw-bold mb-4">${name} 程序流水線</h1>
            <div class="row g-3">
                <div class="col-md-3"><div class="phase-column">
                    <div class="phase-title">階段 01：調查與聽證</div>
                    ${renderGrouped(init)}
                </div></div>
                <div class="col-md-4"><div class="phase-column">
                    <div class="phase-title">階段 02：主體認定 (基礎)</div>
                    ${renderGrouped(recognition)}
                </div></div>
                <div class="col-md-5"><div class="phase-column">
                    <div class="phase-title">階段 03：財產處分 (執行)</div>
                    ${renderGrouped(execution)}
                </div></div>
            </div>`;
    }

    function renderGrouped(cases) {
        if (cases.length === 0) return '<p class="text-muted small">無紀錄</p>';
        const groups = [...new Set(cases.map(c => c.subGroup))].sort();
        return groups.map(g => `
            <div class="group-header">${g}</div>
            ${cases.filter(c => c.subGroup === g).map(c => `
                <div class="case-card" onclick="location.hash='#/case/${c.id}'">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="status-badge ${c.displayStatus.class}">${c.displayStatus.label}</span>
                        ${c.hasOrder ? '<i class="bi bi-hammer text-danger"></i>' : ''}
                    </div>
                    <div class="small fw-bold" style="font-size: 0.75rem;">${c.title}</div>
                </div>`).join('')}`).join('');
    }

    function renderDetail(container, id) {
        const item = processedData.find(i => i.id === id);
        if (!item) return;
        container.innerHTML = `
            <div class="mb-4"><button onclick="history.back()" class="btn btn-link p-0 text-muted text-decoration-none"><i class="bi bi-arrow-left"></i> 返回流水線</button></div>
            <div class="card glass-card p-5">
                <span class="badge ${item.displayStatus.class} mb-3" style="width: fit-content;">${item.displayStatus.label}</span>
                <h2 class="fw-bold mb-3">${item.title}</h2>
                <p class="text-muted">分類：${item.category} | <a href="${item.url}" target="_blank">官方連結</a></p>
                <hr><h4 class="fw-bold mb-4 mt-4">時間軸進度與主文詳情</h4>
                <div class="ps-3">
                    ${[...item.events].sort((a,b) => new Date(b.date) - new Date(a.date)).map(e => `
                        <div class="ps-4 mb-4 border-start border-primary border-3 position-relative">
                            <div class="position-absolute bg-primary rounded-circle" style="width:10px; height:10px; left:-7px; top:6px;"></div>
                            <div class="fw-bold small">${e.date} - ${e.caption}</div>
                            ${e.description ? `<div class="event-desc">${e.description}</div>` : ''}
                        </div>`).join('')}
                </div>
            </div>`;
    }

    function updateSidebar() {
        const nav = document.getElementById('org-nav');
        const orgs = Object.keys(orgMap).sort();
        let html = `<li class="nav-item"><a class="nav-link ${window.location.hash==='#/'?'active':''}" href="#/"><i class="bi bi-speedometer2 me-2"></i>績效概覽</a></li><div class="small text-muted mt-4 mb-2 px-3 text-uppercase">組織</div>`;
        orgs.forEach(o => {
            const active = window.location.hash === `#/org/${encodeURIComponent(o)}`;
            html += `<li class="nav-item"><a class="nav-link ${active?'active':''}" href="#/org/${encodeURIComponent(o)}"><i class="bi bi-building me-2"></i>${o.length > 12 ? o.substring(0,12)+'..' : o}</a></li>`;
        });
        nav.innerHTML = html;
    }
    window.addEventListener('hashchange', router); window.addEventListener('load', router);
</script>
</body>
</html>
